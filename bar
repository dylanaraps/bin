#!/usr/bin/env dash
# vim: set ft=sh:
#
# Dylan's bar script
#
# Created by Dylan Araps.
#
# Depends on: xorg-xrandr, wmctrl, mpc, lemonbar, ip


get_mon_width() {
    # Get the monitor width.
    type -p xrandr --nograb --current >/dev/null 2>&1 && \
        resolution="$(xrandr --nograb --current | \
                      awk -F 'x|\t' '/\*/ {print $1; exit}')"

    printf "%s\\n" "$resolution"
}

get_workspaces() {
    # Get the current workspace.
    current_workspace="$(wmctrl -d | awk '/\*/ {print $NF}')"

    case "$current_workspace" in
        1) workspaces="/1/   2    3    4    5    6" ;;
        2) workspaces=" 1   /2/   3    4    5    6" ;;
        3) workspaces=" 1    2   /3/   4    5    6" ;;
        4) workspaces=" 1    2    3   /4/   5    6" ;;
        5) workspaces=" 1    2    3    4   /5/   6" ;;
        6) workspaces=" 1    2    3    4    5   /6/" ;;
    esac

    printf "%s\\n" "$workspaces"
}

get_date() {
    # Get the date using printf's '%(T)' format.
    printf "%s\\n" "$(date +"%a %d %b - %l:%M %p")"
}

get_song() {
    # Get the current song from spotify.
    song="$(\
        dbus-send --print-reply \
                  --dest=org.mpris.MediaPlayer2.spotify /org/mpris/MediaPlayer2 \
                  org.freedesktop.DBus.Properties.Get \
                  string:'org.mpris.MediaPlayer2.Player' \
                  string:'Metadata' |\
        awk -F 'string "' '/string|array/ {printf "%s",$2; next}{print ""}' |\
        awk -F '"|\\(|-|&' '/artist/ {a=$2} /title/ {t=$2} END{print a " - " t}'
    )"

    # Print song if something is playing.
    if [ "${#song}" -lt 5 ]; then
        printf "%s\\n" "song: Not playing"
    else
        printf "%s%.75s\\n" "song: " "${song}"
    fi
}

get_volume() {
    # Get the system volume.
    volume="$(amixer sget Master | grep -o -m 1 -E "[[:digit:]]+%")"
    printf "%s\\n" "vol: ${volume}"

}

get_local_ip() {
    # Get the local IP address.
    local_ip="$(ip route get 1 | awk -F 'src | uid' '{print $2; exit}')"
    printf "%s\\n" "local ip: ${local_ip}"
}

main() {
    # Main script function.

    # Import colors from 'wal'.
    # https://github.com/dylanaraps/pywal
    . "${HOME}/.cache/wal/colors.sh"

    # Info that doesn't need to grabbed more than once.
    font="${BAR_FONT:-"-benis-lemon-medium-r-normal--10-110-75-75-m-50-iso8859-9"}"
    height="${BAR_HEIGHT:-30}"
    width="$(get_mon_width)"
    local_ip="$(get_local_ip)"

    # Loop and print the info.
    while :; do
        workspaces="$(get_workspaces)"
        date="$(get_date)"
        song="$(get_song)"
        volume="$(get_volume)"

        printf "%s%s%s\\n" \
               "%{l}   ${workspaces}" \
               "%{c}${date}" \
               "%{r}${song}  |  ${volume}  |  ${local_ip}    "
        sleep .1s
    done |\

    # Launch lemonbar.
    lemonbar -g "${width}x${height}" \
             -B "${color0:-#000000}" -F "${color8:-#666666}"\
             -n "bar" -f "$font"
}


main "$@"
