#!/usr/bin/env bash
#
# Dylan's Lemonbar script
#
# Created by Dylan Araps.
#
# Depends on: xorg-xrandr, xorg-xrandr, mpc, lemonbar

# Options.
height="30"
font="-benis-lemon-medium-r-normal--10-110-75-75-m-50-iso8859-9"

# Import colors from 'wal'.
# https://github.com/dylanaraps/pywal
source "${HOME}/.cache/wal/colors.sh"


get_mon_width() {
    # Get the monitor width.
    local resolution
    local xrandr_cmd

    xrandr_cmd=("xrandr" "--nograb" "--current")

    type -p "${xrandr_cmd[@]}" >/dev/null 2>&1 && \
        resolution="$("${xrandr_cmd[@]}" | awk -F 'x|\t' '/\*/ {print $1; exit}')"

    printf "%s\n" "${resolution:-1920}"
}

ws() {
    # Format workspace "blocks".
    local ws_bg
    local ws_fg

    # If focused.
    if [[ "$2" ]]; then
        ws_bg="${color15:-#F0F0F0}"
        ws_fg="${color0:-#000000}"
    fi

    printf "%s%s%s\n" "%{B${ws_bg:-${color2:-#000000}}}" \
                      "%{F${ws_fg:-${color15:-#F0F0F0}}}" \
                      "   ${1}   %{F-}%{B-}"
}

get_workspaces() {
    # Get the current workspace.
    local current_workspace
    local workspaces
    current_workspace="$(xprop -root -notype _NET_CURRENT_DESKTOP)"

    case "${current_workspace/* = }" in
        1) workspaces="$(ws 1 1)$(ws 2)$(ws 3)$(ws 4)$(ws 5)$(ws 6)" ;;
        2) workspaces="$(ws 1)$(ws 2 1)$(ws 3)$(ws 4)$(ws 5)$(ws 6)" ;;
        3) workspaces="$(ws 1)$(ws 2)$(ws 3 1)$(ws 4)$(ws 5)$(ws 6)" ;;
        4) workspaces="$(ws 1)$(ws 2)$(ws 3)$(ws 4 1)$(ws 5)$(ws 6)" ;;
        5) workspaces="$(ws 1)$(ws 2)$(ws 3)$(ws 4)$(ws 5 1)$(ws 6)" ;;
        6) workspaces="$(ws 1)$(ws 2)$(ws 3)$(ws 4)$(ws 5)$(ws 6 1)" ;;
    esac

    printf "%s\n" "$workspaces"
}

get_song() {
    # Get the current song.
    printf "%s\n" "$(mpc current)"
}

get_date() {
    # Get the date using printf's '%(T)' format.
    printf "%(%a %d %b - %l:%M %p)T\n" # shellcheck disable=SC2183
}

main() {
    local width
    local workspaces
    local song
    local date

    width="$(get_mon_width)"

    # Loop and print the info.
    while :; do
        workspaces="$(get_workspaces)"
        song="$(get_song)"
        date="$(get_date)"

        printf "%s%s%s\n" \
               "%{l}     ${workspaces}" \
               "%{c}${date}" \
               "%{r}${song}     "
        sleep .3s
    done |\

    # Launch lemonbar.
    lemonbar -g "${width}x${height}" -f "$font" \
             -B "${color0:-#f0f0f0}" -F "${color15:-#000000}"\
             -n "bar" # &
}

main "$@"
